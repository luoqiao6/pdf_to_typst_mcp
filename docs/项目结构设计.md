# PDF转Typst工具项目结构设计

## 项目概述

### 设计原则
- **模块化设计**：每个功能模块独立，降低耦合度
- **接口标准化**：统一的接口设计，便于扩展和维护
- **配置外部化**：配置参数可配置，便于部署和调试
- **测试友好**：便于单元测试和集成测试

### 技术栈
- **后端**：Python 3.8+
- **PDF处理**：pdfplumber + PyMuPDF
- **Web框架**：Flask
- **数据处理**：NumPy, Pandas
- **图像处理**：Pillow, OpenCV
- **测试框架**：pytest

## 目录结构

```
PDFConvert/
├── README.md                 # 项目说明文档
├── requirements.txt          # Python依赖包
├── setup.py                 # 项目安装配置
├── .gitignore               # Git忽略文件
├── .env.example             # 环境变量示例
├── docs/                    # 项目文档
│   ├── 开发计划.md         # 开发计划
│   ├── 技术调研报告.md     # 技术调研报告
│   ├── 项目结构设计.md     # 本文档
│   ├── API文档.md          # API接口文档
│   ├── 部署指南.md         # 部署说明
│   └── 用户手册.md         # 用户使用说明
├── src/                     # 源代码目录
│   ├── __init__.py
│   ├── main.py              # 主程序入口
│   ├── config/              # 配置模块
│   │   ├── __init__.py
│   │   ├── settings.py      # 配置设置
│   │   └── constants.py     # 常量定义
│   ├── core/                # 核心功能模块
│   │   ├── __init__.py
│   │   ├── pdf_parser/      # PDF解析模块
│   │   │   ├── __init__.py
│   │   │   ├── base.py      # 基础解析器接口
│   │   │   ├── pdfplumber_parser.py  # pdfplumber解析器
│   │   │   ├── pymupdf_parser.py     # PyMuPDF解析器
│   │   │   └── hybrid_parser.py      # 混合解析器
│   │   ├── content_analyzer/ # 内容分析模块
│   │   │   ├── __init__.py
│   │   │   ├── text_analyzer.py      # 文本分析器
│   │   │   ├── table_analyzer.py     # 表格分析器
│   │   │   ├── image_analyzer.py     # 图像分析器
│   │   │   └── academic_analyzer.py  # 学术内容分析器
│   │   ├── typst_generator/ # Typst生成模块
│   │   │   ├── __init__.py
│   │   │   ├── document_generator.py # 文档生成器
│   │   │   ├── table_generator.py    # 表格生成器
│   │   │   ├── image_generator.py    # 图像生成器
│   │   │   └── style_mapper.py       # 样式映射器
│   │   └── utils/           # 工具模块
│   │       ├── __init__.py
│   │       ├── file_utils.py         # 文件处理工具
│   │       ├── image_utils.py        # 图像处理工具
│   │       ├── text_utils.py         # 文本处理工具
│   │       └── memory_utils.py       # 内存管理工具
│   ├── web/                 # Web应用模块
│   │   ├── __init__.py
│   │   ├── app.py           # Flask应用
│   │   ├── routes/          # 路由模块
│   │   │   ├── __init__.py
│   │   │   ├── api.py       # API路由
│   │   │   └── views.py     # 页面路由
│   │   ├── models/          # 数据模型
│   │   │   ├── __init__.py
│   │   │   └── pdf_document.py       # PDF文档模型
│   │   ├── services/        # 业务逻辑服务
│   │   │   ├── __init__.py
│   │   │   ├── conversion_service.py # 转换服务
│   │   │   └── file_service.py       # 文件服务
│   │   └── static/          # 静态文件
│   │       ├── css/         # 样式文件
│   │       ├── js/          # JavaScript文件
│   │       └── images/      # 图像文件
│   └── cli/                 # 命令行工具
│       ├── __init__.py
│       ├── main.py          # CLI主程序
│       └── commands.py      # CLI命令
├── tests/                   # 测试目录
│   ├── __init__.py
│   ├── conftest.py          # pytest配置
│   ├── unit/                # 单元测试
│   │   ├── __init__.py
│   │   ├── test_pdf_parser.py
│   │   ├── test_content_analyzer.py
│   │   └── test_typst_generator.py
│   ├── integration/         # 集成测试
│   │   ├── __init__.py
│   │   └── test_end_to_end.py
│   └── fixtures/            # 测试数据
│       ├── sample_pdfs/     # 测试用PDF文件
│       ├── expected_outputs/ # 期望输出
│       └── test_configs/    # 测试配置
├── scripts/                 # 脚本目录
│   ├── install.sh           # 安装脚本
│   ├── run_tests.sh         # 测试运行脚本
│   └── deploy.sh            # 部署脚本
├── data/                    # 数据目录
│   ├── uploads/             # 上传文件临时目录
│   ├── outputs/             # 输出文件目录
│   └── images/              # 提取的图像文件
├── logs/                    # 日志目录
│   ├── app.log              # 应用日志
│   ├── error.log            # 错误日志
│   └── conversion.log       # 转换日志
└── docker/                  # Docker配置
    ├── Dockerfile           # Docker镜像构建文件
    ├── docker-compose.yml   # Docker Compose配置
    └── .dockerignore        # Docker忽略文件
```

## 核心模块设计

### 1. PDF解析模块 (src/core/pdf_parser/)

#### 模块职责
- 提供统一的PDF解析接口
- 实现多种PDF解析策略
- 管理解析器的生命周期

#### 核心类设计
```python
# src/core/pdf_parser/base.py
from abc import ABC, abstractmethod
from typing import List, Dict, Any

class PDFParserInterface(ABC):
    """PDF解析器接口"""
    
    @abstractmethod
    def extract_text(self, pdf_path: str) -> List[Dict[str, Any]]:
        """提取文本内容"""
        pass
    
    @abstractmethod
    def extract_tables(self, pdf_path: str) -> List[Dict[str, Any]]:
        """提取表格"""
        pass
    
    @abstractmethod
    def extract_images(self, pdf_path: str) -> List[Dict[str, Any]]:
        """提取图像"""
        pass
    
    @abstractmethod
    def extract_styling(self, pdf_path: str) -> List[Dict[str, Any]]:
        """提取样式信息"""
        pass
    
    @abstractmethod
    def close(self) -> None:
        """关闭解析器，释放资源"""
        pass

# src/core/pdf_parser/hybrid_parser.py
class HybridPDFParser:
    """混合PDF解析器"""
    
    def __init__(self):
        self.text_parser = PDFPlumberParser()
        self.styling_parser = PyMuPDFParser()
    
    def parse_pdf(self, pdf_path: str) -> Dict[str, Any]:
        """使用混合方案解析PDF"""
        # 并行执行两个解析任务
        # 合并结果
        # 返回统一格式
```

### 2. 内容分析模块 (src/core/content_analyzer/)

#### 模块职责
- 分析PDF内容的语义结构
- 识别学术文档特征
- 为Typst生成提供结构化数据

#### 核心类设计
```python
# src/core/content_analyzer/academic_analyzer.py
class AcademicContentAnalyzer:
    """学术内容分析器"""
    
    def analyze_document_structure(self, content: Dict[str, Any]) -> Dict[str, Any]:
        """分析文档结构"""
        return {
            'headings': self.analyze_headings(content['text']),
            'paragraphs': self.analyze_paragraphs(content['text']),
            'tables': self.analyze_tables(content['tables']),
            'images': self.analyze_images(content['images']),
            'citations': self.identify_citations(content['text']),
            'references': self.identify_references(content['text'])
        }
    
    def analyze_headings(self, text_content: List[Dict]) -> List[Dict]:
        """分析标题层级"""
        # 基于字体大小、位置、样式识别标题
        # 建立标题层级关系
        pass
```

### 3. Typst生成模块 (src/core/typst_generator/)

#### 模块职责
- 将分析结果转换为Typst语法
- 管理Typst模板和样式
- 生成最终的.typ文件

#### 核心类设计
```python
# src/core/typst_generator/document_generator.py
class TypstDocumentGenerator:
    """Typst文档生成器"""
    
    def __init__(self, template_path: str = None):
        self.template = self.load_template(template_path)
        self.style_mapper = StyleMapper()
    
    def generate_document(self, analyzed_content: Dict[str, Any]) -> str:
        """生成完整的Typst文档"""
        typst_content = []
        
        # 添加文档头部
        typst_content.extend(self.generate_header())
        
        # 生成目录
        typst_content.extend(self.generate_toc(analyzed_content['headings']))
        
        # 生成正文内容
        typst_content.extend(self.generate_main_content(analyzed_content))
        
        # 生成参考文献
        if analyzed_content.get('references'):
            typst_content.extend(self.generate_references(analyzed_content['references']))
        
        return '\n'.join(typst_content)
```

### 4. Web应用模块 (src/web/)

#### 模块职责
- 提供Web用户界面
- 处理文件上传和下载
- 管理转换任务和进度

#### 核心类设计
```python
# src/web/app.py
from flask import Flask
from src.web.routes import api_bp, views_bp

def create_app(config_name: str = 'default'):
    """创建Flask应用"""
    app = Flask(__name__)
    
    # 配置应用
    app.config.from_object(f'src.config.settings.{config_name.capitalize()}Config')
    
    # 注册蓝图
    app.register_blueprint(api_bp, url_prefix='/api')
    app.register_blueprint(views_bp)
    
    return app

# src/web/services/conversion_service.py
class ConversionService:
    """PDF转换服务"""
    
    def __init__(self):
        self.parser = HybridPDFParser()
        self.analyzer = AcademicContentAnalyzer()
        self.generator = TypstDocumentGenerator()
    
    def convert_pdf_to_typst(self, pdf_path: str) -> str:
        """转换PDF为Typst"""
        # 解析PDF
        parsed_content = self.parser.parse_pdf(pdf_path)
        
        # 分析内容
        analyzed_content = self.analyzer.analyze_document_structure(parsed_content)
        
        # 生成Typst
        typst_content = self.generator.generate_document(analyzed_content)
        
        return typst_content
```

## 配置管理

### 配置文件结构
```python
# src/config/settings.py
import os
from typing import Dict, Any

class BaseConfig:
    """基础配置"""
    # 应用配置
    SECRET_KEY = os.environ.get('SECRET_KEY') or 'dev-secret-key'
    MAX_CONTENT_LENGTH = 16 * 1024 * 1024  # 16MB
    
    # 文件路径配置
    UPLOAD_FOLDER = 'data/uploads'
    OUTPUT_FOLDER = 'data/outputs'
    IMAGES_FOLDER = 'data/images'
    
    # PDF处理配置
    MAX_PDF_PAGES = 1000
    MAX_MEMORY_USAGE = 2048  # MB
    
    # 并发配置
    MAX_WORKERS = 2
    TIMEOUT = 300  # 秒

class DevelopmentConfig(BaseConfig):
    """开发环境配置"""
    DEBUG = True
    TESTING = False

class ProductionConfig(BaseConfig):
    """生产环境配置"""
    DEBUG = False
    TESTING = False
    # 生产环境特定配置

class TestingConfig(BaseConfig):
    """测试环境配置"""
    TESTING = True
    DEBUG = True
    # 测试环境特定配置
```

## 数据模型设计

### 核心数据类
```python
# src/web/models/pdf_document.py
from dataclasses import dataclass
from typing import List, Dict, Any, Optional
from datetime import datetime

@dataclass
class PDFDocument:
    """PDF文档模型"""
    id: str
    filename: str
    file_path: str
    file_size: int
    page_count: int
    upload_time: datetime
    status: str  # pending, processing, completed, failed
    conversion_result: Optional[str] = None
    error_message: Optional[str] = None

@dataclass
class ConversionTask:
    """转换任务模型"""
    id: str
    pdf_document: PDFDocument
    start_time: datetime
    end_time: Optional[datetime] = None
    progress: float = 0.0
    status: str = 'pending'
```

## 测试策略

### 测试结构
```
tests/
├── unit/                    # 单元测试
│   ├── test_pdf_parser.py  # PDF解析器测试
│   ├── test_content_analyzer.py  # 内容分析器测试
│   └── test_typst_generator.py   # Typst生成器测试
├── integration/             # 集成测试
│   └── test_end_to_end.py  # 端到端测试
└── fixtures/                # 测试数据
    ├── sample_pdfs/         # 测试PDF文件
    └── expected_outputs/    # 期望输出结果
```

### 测试配置
```python
# tests/conftest.py
import pytest
from src.web.app import create_app
from src.config.settings import TestingConfig

@pytest.fixture
def app():
    """创建测试应用"""
    app = create_app('testing')
    return app

@pytest.fixture
def client(app):
    """创建测试客户端"""
    return app.test_client()

@pytest.fixture
def sample_pdf_path():
    """提供测试PDF文件路径"""
    return 'tests/fixtures/sample_pdfs/test_document.pdf'
```

## 部署配置

### Docker配置
```dockerfile
# docker/Dockerfile
FROM python:3.9-slim

WORKDIR /app

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# 复制依赖文件
COPY requirements.txt .

# 安装Python依赖
RUN pip install --no-cache-dir -r requirements.txt

# 复制应用代码
COPY . .

# 暴露端口
EXPOSE 5000

# 启动命令
CMD ["python", "src/main.py"]
```

### Docker Compose配置
```yaml
# docker/docker-compose.yml
version: '3.8'

services:
  pdf-converter:
    build: .
    ports:
      - "5000:5000"
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
    environment:
      - FLASK_ENV=production
      - MAX_WORKERS=4
    restart: unless-stopped
```

## 开发工作流

### 开发流程
1. **功能开发**：在feature分支开发新功能
2. **单元测试**：为新功能编写单元测试
3. **集成测试**：确保模块间协作正常
4. **代码审查**：提交Pull Request进行代码审查
5. **合并主分支**：通过审查后合并到主分支

### 版本管理
- 使用语义化版本号 (Semantic Versioning)
- 主版本号：不兼容的API修改
- 次版本号：向下兼容的功能性新增
- 修订号：向下兼容的问题修正

### 发布流程
1. 更新版本号
2. 生成发布说明
3. 创建发布标签
4. 构建Docker镜像
5. 部署到生产环境

---

**文档版本**：1.0
**最后更新**：2024年12月
**维护人员**：[待定]
